import traceback
from datetime import datetime, timedelta


holiday_list = ['2014-12-26','2015-1-1','2015-2-9','2015-4-3','2015-4-6','2015-5-18','2015-7-1','2015-8-3','2015-9-7','2015-10-12','2015-11-11','2015-12-25','2015-12-28','2016-1-1','2016-2-8','2016-3-25','2016-3-28','2016-5-23','2016-7-1','2016-8-1','2016-9-5','2016-10-10','2016-11-11','2016-12-26','2016-12-27','2017-1-2','2017-2-13','2017-4-14','2017-4-17','2017-5-22','1993-1-1','1993-4-9','1993-4-12','1993-5-24','1993-7-1','1993-8-2','1993-9-6','1993-10-11','1993-11-11','1993-12-25','1993-12-26','1994-1-3','1994-4-1','1994-5-23','1994-7-1','1994-8-1','1994-9-5','1994-10-10','1994-11-11','1994-12-26','1994-12-27','1995-1-2','1995-4-14','1995-5-22','1995-6-30','1995-8-7','1995-9-4','1995-10-9','1995-11-10','1995-11-13','1995-12-25','1995-12-26','1996-1-1','1996-4-5','1996-4-8','1996-5-20','1996-7-1','1996-8-4','1996-8-5','1996-9-2','1996-10-14','1996-11-11','1996-12-25','1996-12-26','1997-1-1','1997-3-28','1997-3-31','1997-5-19','1997-7-1','1997-8-4','1997-9-1','1997-10-13','1997-11-11','1997-12-25','1997-12-26','1998-1-1','1998-4-10','1998-4-12','1998-5-18','1998-7-1','1998-8-4','1998-9-7','1998-10-12','1998-11-11','1998-12-25','1998-12-26','1999-1-1','1999-4-2','1999-4-5','1999-5-24','1999-7-1','1999-8-2','1999-9-6','1999-10-11','1999-11-11','1999-12-25','1999-12-26','2000-1-3','2000-4-21','2000-4-24','2000-5-22','2000-7-1','2000-8-7','2000-9-4','2000-10-9','2000-11-11','2000-12-25','2000-12-26','2001-1-1','2001-4-13','2001-4-16','2001-5-21','2001-7-2','2001-8-6','2001-9-3','2001-10-8','2001-11-12','2001-12-25','2001-12-26','2002-1-1','2002-3-29','2002-4-1','2002-5-20','2002-7-1','2002-8-5','2002-9-2','2002-10-14','2002-11-11','2002-12-25','2002-12-26','2003-12-25','2003-12-26','2004-1-1','2004-4-18','2004-4-21','2004-5-24','2004-7-1','2004-8-2','2004-9-6','2004-10-11','2004-11-11','2004-12-27','2004-12-28','2005-1-3','2005-3-25','2005-3-28','2005-5-23','2005-7-1','2005-8-1','2005-9-5','2005-10-10','2005-11-11','2005-12-26','2005-12-27','2006-1-2','2006-4-14','2006-4-17','2006-5-22','2006-7-3','2006-8-7','2006-9-4','2006-10-9','2006-11-13','2006-12-25','2006-12-26','2007-1-1','2007-4-6','2007-4-9','2007-5-21','2007-7-2','2007-8-6','2007-9-3','2007-10-8','2007-11-12','2007-12-25','2007-12-26','2008-1-1','2008-3-21','2008-3-24','2008-4-10','2008-5-19','2008-7-1','2008-8-4','2008-9-1','2008-10-13','2008-11-11','2008-12-25','2008-12-26','2009-1-1','2009-4-10','2009-4-13','2009-5-18','2009-7-1','2009-8-3','2009-9-7','2009-10-12','2009-11-11','2009-12-25','2009-12-26','2009-12-28','2010-1-1','2010-4-2','2010-4-5','2010-5-24','2010-7-1','2010-8-2','2010-9-6','2010-10-11','2010-11-11','2010-12-27','2010-12-28','2011-1-3','2011-4-22','2011-4-25','2011-5-23','2011-7-1','2011-8-1','2011-9-5','2011-10-10','2011-11-11','2011-12-26','2011-12-27','2012-1-2','2012-4-6','2012-4-9','2012-5-21','2012-7-2','2012-8-6','2012-9-3','2012-10-8','2012-11-12','2012-12-25','2012-12-26','2013-1-1','2013-2-11','2013-3-29','2013-4-1','2013-5-20','2013-7-1','2013-8-5','2013-9-2','2013-10-14','2013-11-11','2013-12-25','2013-12-26','2014-1-1','2014-2-10','2014-4-18','2014-4-21','2014-5-19','2014-7-1','2014-8-4','2014-9-1','2014-10-13','2014-11-11','2014-12-25','2017-7-3','2017-8-7','2017-9-4','2017-10-9','2017-11-13','2017-12-25','2017-12-26','2018-1-1','2018-12-26','2018-12-25','2018-11-12','2018-10-8','2018-9-3','2018-8-6','2018-7-2','2018-5-21','2018-4-2','2018-3-30','2018-2-12','2020-4-10','2020-4-13','2020-5-18','2020-7-1','2020-8-3','2020-9-7','2020-10-12','2020-11-11','2020-12-25','2020-12-28','2021-1-1','2021-2-15','2021-4-2','2021-4-5','2021-5-24','2021-7-1','2021-8-2','2021-9-6','2021-10-11','2021-11-11','2021-12-27','2021-12-28','2022-1-3','2022-2-21','2022-4-15','2022-4-18','2022-5-23','2022-7-1','2022-8-1','2022-9-5','2022-9-30','2022-10-10','2022-11-11','2022-12-26','2022-12-27','2023-1-2','2023-2-20','2023-4-7','2023-4-10','2023-5-22','2023-7-3','2023-8-7','2023-9-4','2023-9-30','2023-10-9','2023-11-13','2023-12-25','2023-12-26']


def calculate_minute_difference(start_date_str, end_date_str, holidays=[]):
    try:
        # Convert the date strings to datetime objects
        cur_date = start_date = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M:%S')
        end_date = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M:%S')

        # Calculate the difference in days excluding the start and end days as we are saving their times below
        days_count = (end_date.date() - start_date.date()).days - 1

        # Calculate the number of weekends (Saturday and Sunday) and holidays in the date range
        weekends = 0
        holidays_count = 0

        # Saving the time(seconds) of the start date and end date 
        flat_start = datetime.strftime(start_date + timedelta(days=1), '%Y-%m-%d')
        flat_end = datetime.strftime(end_date, '%Y-%m-%d')
        
        extra_start_time = ((datetime.strptime(flat_start, '%Y-%m-%d')) - start_date).total_seconds()
        extra_end_time = (end_date - (datetime.strptime(flat_end, '%Y-%m-%d'))).total_seconds()
        
        while cur_date.date() <= end_date.date():
            day = cur_date

            if day.weekday() >= 5:
                if day.date() == start_date.date():
                    cur_date = cur_date + timedelta(days=1)
                    extra_start_time = 0
                    continue
                elif day.date() == end_date.date():
                    extra_end_time = 0
                    break
                weekends += 1 # 5 and 6 represent Saturday and Sunday
            elif day.date() in holidays:
                if day.date() == start_date.date():
                    cur_date = cur_date + timedelta(days=1)
                    extra_start_time = 0
                    continue
                elif day.date() == end_date.date():
                    extra_end_time = 0
                    break
                holidays_count += 1

            cur_date = cur_date + timedelta(days=1)

        # Calculate the minute difference, excluding weekends and holidays
        sec_difference = (days_count * 24 * 3600 ) - ((weekends + holidays_count) * 24 * 60 * 60) + extra_start_time + extra_end_time

        return sec_difference
    except:
        print(traceback.format_exc())


# Example usage:
start_date_str = "2023-06-19 10:00:00"
end_date_str = "2023-06-20 00:00:01"
holiday_list = [
    '2023-6-21',
    '2023-6-23'
]

# Convert the holiday list elements into python datetime obj as the date format of the elements is not uniform. 
holiday_date_objects = []
for date_str in set(holiday_list):
    date_obj = datetime.strptime(date_str, '%Y-%m-%d').date()
    holiday_date_objects.append(date_obj)

seconds_diff = calculate_minute_difference(start_date_str, end_date_str, holiday_date_objects)

print("Seconds difference (excluding weekends and holidays):", seconds_diff)
print("Minutes difference (excluding weekends and holidays):", seconds_diff / 60)
print("Hours difference (excluding weekends and holidays):", seconds_diff / 3600)
print("Days difference (excluding weekends and holidays):", seconds_diff / 3600 / 24)